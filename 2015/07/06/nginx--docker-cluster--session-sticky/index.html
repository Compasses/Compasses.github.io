
<!DOCTYPE html>
<html lang="en-EN">
<head>

  
  <meta charset="UTF-8">
  <title>
    Nginx &#43; Docker Cluster &amp; session sticky | 三十重围
  </title>


  
  <meta name="viewport" content="width=device-width,user-scalable=no,maximum-scale=1,initial-scale=1">

  
  <link rel="canonical" href="http://compasses.github.io/2015/07/06/nginx--docker-cluster--session-sticky/"/>

  
  <link rel="stylesheet" href="/css/sanitize.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <link rel="stylesheet" href="/css/highlight_monokai.css">
  <link rel="stylesheet" href="/css/theme.css">
  <link rel="stylesheet" href="/css/custom.css">
  
  
  <link href="http://compasses.github.io/index.xml" rel="alternate" type="application/rss+xml" title="三十重围" />
  <link href="http://compasses.github.io/index.xml" rel="feed" type="application/rss+xml" title="三十重围" />

  
  <script type="text/javascript">var switchTo5x=true;</script>
  <script type="text/javascript" src="https://ws.sharethis.com/button/buttons.js"></script>
  <script type="text/javascript">stLight.options({publisher: "2b9fffc6-b3fe-4988-a0ef-4f9dcce98eaa", doNotHash: true, doNotCopy: true, hashAddressBar: false});</script>


</head>



<body>
<div class="container">

  
  <header role="banner">
    <div class="row gutters">
      <div id="site-title" class="col span_6">
        <h1><a href="http://compasses.github.io/">三十重围</a></h1>
        <h2>并蓄 | 共享</h2>
      </div>
      <div id="social" class="col span_6">
        <ul>
          
          
          <li><a href="https://github.com/compasses" target="_blank">GitHub</a></li>
          
        </ul>
      </div>
    </div>
  </header>


  
  <main id="single" role="main">
    <div class="article-header">
      <h1>Nginx &#43; Docker Cluster &amp; session sticky</h1>
      <div class="meta">
        Jul 6, 2015 &nbsp;
        
          #<a href="/tags/ngnix">Ngnix</a>&nbsp;
        
      </div>
    </div>
    <article>
      

<h2 id="基本配置">基本配置</h2>

<p>本地开发环境和生产环境还是有很大的区分，最近性能测试发现结果很不好，于是想自己去搭建一个类似生产环境的性能测试环境。</p>

<p>由于前期已经有了docker的开发环境，这里只需要增加Nginx 作为反向代理。
在/etc/nginx/conf.d目录下新建文件例如proxyServer.conf，添加如下内容</p>

<pre><code>## Basic reverse proxy server
upstream dockerServer  {
    ip_hash;
    server 10.128.163.121:7080;
    server 10.128.163.121:17080;
}

upstream dockerServerSSL  {
    ip_hash;
    server 10.128.163.121:7443;
    server 10.128.163.121:17443;
}

server {
    listen 80;
    server_name  10.128.163.121;

    ##access_log  logs/60.access.log  main;
    error_log  logs/60.error.log;
    root   html;
    index  index.html index.htm index.php;

    ## send request back to apache ##
    location / {
        proxy_pass  http://dockerServer ;

        #Proxy Settings
        proxy_redirect     off;
        proxy_set_header   Host             $host;
        proxy_set_header   X-Real-IP        $remote_addr;
        proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        proxy_max_temp_file_size 0;
        proxy_connect_timeout      90;
        proxy_send_timeout         90;
        proxy_read_timeout         90;
        proxy_buffer_size          4k;
        proxy_buffers              4 32k;
        proxy_busy_buffers_size    64k;
        proxy_temp_file_write_size 64k;
   }
}
server {
    listen 443;
    server_name  10.128.163.121;
    ssl on;
    ssl_certificate /etc/nginx/conf.d/server.crt;
    ssl_certificate_key /etc/nginx/conf.d/server.key;

    ##access_log  logs/60.access.log  main;
    error_log  logs/60.error.log;
    root   html;
    index  index.html index.htm index.php;

    ## send request back to apache ##
    location / {
        proxy_pass  https://dockerServerSSL ;

        #Proxy Settings
        proxy_redirect     off;
        proxy_set_header   Host             $host;
        proxy_set_header   X-Real-IP        $remote_addr;
        proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        proxy_max_temp_file_size 0;
        proxy_connect_timeout      90;
        proxy_send_timeout         90;
        proxy_read_timeout         90;
        proxy_buffer_size          4k;
        proxy_buffers              4 32k;
        proxy_busy_buffers_size    64k;
        proxy_temp_file_write_size 64k;
   }
}
</code></pre>

<p>注意点：
1. https需要单独配置，由于后端server在https下也要工作，因为某些页面安全性要求较高，需要转成https的。
2. 这里使用的是ip_hash的方式做负载均衡，但是也有一定的缺陷，即在代理访问的情况下客户端ip有可能是会发生改变的，还有就是ip在负载均衡上均衡比较困难。
3. https的crt和key需要<a href="http://www.lovelucy.info/nginx-ssl-certificate-https-website.html">自己生成</a>。
另外这个Nginx 是跑在宿主机上的，修改配置有要执行reload命令使其生效。</p>

<h2 id="session-persistence">session persistence</h2>

<p>生产环境需要将一个用户的请求要路由到同一个server上面，因为server很多的业务处理还是需要server里面的session配合。上面用ip_hash方式做load balance，但是考虑到用户使用proxy或者流量不均衡等因素。还是要使用session sticky的方式。
Nginx默认不支持session sticky，需要重新编译安装这个插件；因为直接使用公司的Nginx版本，所以懒得重新编译了。使用很简单，直接拷贝个bin文件，然后修改成这个样子：</p>

<pre><code>upstream dockerServer  {
      sticky name=yourname httponly path=/ hash=md5;
       server 10.128.163.121:17080;
       server 10.128.163.121:7080;
   }
   
  upstream dockerServerSSL  {
     sticky name=yourname httponly path=/ hash=md5;
     server 10.128.163.121:17443;
     server 10.128.163.121:7443;
 }
</code></pre>

<p>这样直接访问 <a href="http://10.128.163.121">http://10.128.163.121</a> 即可，Nginx会自动路由请求到某一个server上。因为sticky是会话级别的，关掉浏览器会话就结束了。如果重新访问用户可能会被路由到另一个server上，可以通过查询Apache的accesslog来确认。</p>


      
      <div id="share-this" class="col span_10">
        <span class='st_twitter_large' displayText='Tweet'></span>
        <span class='st_facebook_large' displayText='Facebook'></span>
        <span class='st_googleplus_large' displayText='Google +'></span>
        <span class='st_pocket_large' displayText='Pocket'></span>
        <span class='st_sharethis_large' displayText='ShareThis'></span>
        <span class='st_email_large' displayText='Email'></span>
      </div>
    </article>
    
    
	<div class="ds-thread" data-thread-key="" data-title="Nginx &#43; Docker Cluster &amp; session sticky" data-url="http://compasses.github.io/2015/07/06/nginx--docker-cluster--session-sticky/"></div>


<script type="text/javascript">
var duoshuoQuery = {short_name:"compasses"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0]
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>


  </main>

  <nav class="pagination">
    
      <span class="previous">&larr; <a href="http://compasses.github.io/2015/06/26/deadlock-of-mysql/" rel="prev">deadlock of mysql</a></span>
    
    
      <span class="next"><a href="http://compasses.github.io/2015/07/07/web-%E5%BC%80%E5%8F%91%E7%82%B9%E6%BB%B4/" rel="next">WEB 开发点滴</a> &rarr;</span>
    
  </nav>


  
  <footer role="contentinfo">
    <div style="text-align:center;">
      <img src="/images/profile.png" width="64" height="64"><br>
      Written by Jet He
    </div>
  </footer>


</div>

<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



</body>
</html>

